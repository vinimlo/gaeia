---
import ProgressRing from './ProgressRing.astro';
import GaeiaLogo from './GaeiaLogo.astro';
import { getAllTrilhas, getTrilhaTopicoIds, getAllTopicos } from '../utils/trilhas';
import { url } from '../utils/url';

// Load trilhas for navigation
const trilhas = await getAllTrilhas();
const topicos = await getAllTopicos();

// Calculate total unique topics count
const totalTopicos = topicos.length;

interface NavItem {
  label: string;
  href: string;
  icon?: string;
  color?: string;
  badge?: string;
  children?: NavItem[];
}

// Build navigation items
const navigation: NavItem[] = [
  {
    label: 'Inicio',
    href: url('/'),
    icon: 'home'
  },
  {
    label: 'Trilhas',
    href: url('/trilhas'),
    icon: 'book',
    badge: `${trilhas.length}`,
    children: trilhas.map(trilha => ({
      label: trilha.nome,
      href: url(`/trilhas/${trilha.id}`),
    }))
  },
  {
    label: 'Topicos',
    href: url('/topicos'),
    icon: 'tag',
    badge: `${totalTopicos}`
  },
  {
    label: 'Conquistas',
    href: url('/conquistas'),
    icon: 'trophy'
  }
];

const icons: Record<string, string> = {
  home: 'M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6',
  book: 'M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253',
  tag: 'M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z',
  trophy: 'M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z',
};

const currentPath = Astro.url.pathname;
---

<aside class="fixed left-0 top-0 z-40 h-screen w-[280px] bg-nebula/95 backdrop-blur-md border-r border-star-dust/50 transform -translate-x-full md:translate-x-0 transition-transform duration-300 overflow-y-auto">
  <!-- Logo -->
  <div class="p-6 border-b border-star-dust/50">
    <a href={url('/')} class="flex items-center gap-3 group">
      <div class="w-10 h-10 rounded-xl bg-star-dust/30 flex items-center justify-center group-hover:bg-star-dust/50 transition-all">
        <GaeiaLogo size={32} animated={true} />
      </div>
      <div>
        <span class="font-display font-bold text-xl text-bright">GAEIA</span>
        <span class="block text-xs text-dim">Universo de IA</span>
      </div>
    </a>
  </div>

  <!-- Progress Overview (client-hydrated) -->
  <div class="p-4 mx-4 mt-4 rounded-xl bg-star-dust/30" id="sidebar-progress" data-total-topicos={totalTopicos}>
    <div class="flex items-center gap-3">
      <ProgressRing value={0} size={48} strokeWidth={4} />
      <div>
        <span class="block text-sm text-bright font-medium">Progresso Geral</span>
        <span class="text-xs text-dim" id="sidebar-progress-text">0 topicos completos</span>
      </div>
    </div>
  </div>

  <!-- Navigation -->
  <nav class="p-4">
    <ul class="space-y-1">
      {navigation.map((item) => {
        const isActive = currentPath === item.href ||
          (item.href !== '/' && currentPath.startsWith(item.href + '/')) ||
          (item.href !== '/' && currentPath.startsWith(item.href));
        const hasChildren = item.children && item.children.length > 0;
        const iconPath = icons[item.icon || 'home'];

        return (
          <li>
            <a
              href={item.href}
              class:list={[
                'flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all duration-200',
                isActive
                  ? 'bg-synapse-cyan/10 text-synapse-cyan'
                  : 'text-dim hover:text-bright hover:bg-star-dust/50'
              ]}
            >
              <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d={iconPath} />
              </svg>
              <span class="flex-1 font-medium">{item.label}</span>
              {item.badge && (
                <span class="text-xs px-2 py-0.5 rounded-full bg-star-dust/30 text-dim">
                  {item.badge}
                </span>
              )}
              {hasChildren && (
                <svg class:list={[
                  'w-4 h-4 transition-transform',
                  isActive && 'rotate-90'
                ]} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              )}
            </a>

            {/* Children */}
            {hasChildren && isActive && (
              <ul class="ml-8 mt-1 space-y-1 border-l border-star-dust/50 pl-3">
                {item.children!.map((child) => {
                  const childActive = currentPath === child.href || currentPath.startsWith(child.href + '/');
                  return (
                    <li>
                      <a
                        href={child.href}
                        class:list={[
                          'flex items-center gap-2 px-2 py-1.5 rounded text-sm transition-colors',
                          childActive
                            ? 'text-synapse-cyan'
                            : 'text-faint hover:text-dim'
                        ]}
                      >
                        <span class:list={[
                          'w-2 h-2 rounded-full flex-shrink-0',
                          childActive ? 'bg-synapse-cyan' : 'bg-dormant'
                        ]} />
                        <span class="truncate">{child.label}</span>
                      </a>
                    </li>
                  );
                })}
              </ul>
            )}
          </li>
        );
      })}
    </ul>
  </nav>

  <!-- Footer -->
  <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-star-dust/50 bg-nebula/95">
    <div class="flex items-center gap-2 text-xs text-faint">
      <span class="w-2 h-2 rounded-full bg-complete-pulse animate-pulse"></span>
      <span>Estudando ativamente</span>
    </div>
  </div>
</aside>

<!-- Sidebar progress is hydrated by progress-hydrator.ts (loaded in BaseLayout) -->
