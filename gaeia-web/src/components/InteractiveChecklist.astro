---
/**
 * Interactive Checklist Component
 * - Checkboxes that sync with Obsidian vault files (when interactive=true)
 * - Optimistic UI updates
 * - Records activity to localStorage for streaks
 * - Dispatches events for other components to react
 * - Can also be used as a static display (interactive=false)
 */

import type { ChecklistItem } from '../utils/checklist';

interface Props {
  items: ChecklistItem[];
  blockSlug?: string;
  showProgress?: boolean;
  interactive?: boolean;
}

const { items, blockSlug, showProgress = true, interactive = true } = Astro.props;

const completed = items.filter(item => item.checked).length;
const total = items.length;
const progress = total > 0 ? Math.round((completed / total) * 100) : 0;
---

<div class="interactive-checklist" data-block-slug={blockSlug} data-interactive={interactive ? 'true' : 'false'}>
  {showProgress && total > 0 && (
    <div class="flex items-center justify-between text-sm mb-4">
      <span class="text-dim checklist-counter">
        <span class="completed-count">{completed}</span> de {total} itens concluidos
      </span>
      <span class="font-medium text-synapse-cyan checklist-progress">{progress}%</span>
    </div>
  )}

  <ul class="space-y-2" role="list">
    {items.map((item, index) => (
      <li
        class:list={[
          'checklist-item flex items-start gap-3 p-3 rounded-lg transition-all',
          interactive && 'cursor-pointer',
          item.checked
            ? 'bg-complete-pulse/10 is-checked'
            : 'bg-star-dust/30 hover:bg-star-dust/50'
        ]}
        data-index={index}
        data-checked={item.checked ? 'true' : 'false'}
      >
        <span
          class:list={[
            'checkbox-indicator flex-shrink-0 w-5 h-5 rounded-md flex items-center justify-center mt-0.5 transition-all',
            item.checked
              ? 'bg-complete-pulse text-void'
              : 'bg-star-dust border border-dormant'
          ]}
          role="checkbox"
          aria-checked={item.checked}
          tabindex="0"
        >
          <svg class="check-icon w-3.5 h-3.5 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24" style={item.checked ? '' : 'opacity: 0'}>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
          </svg>
        </span>

        <span
          class:list={[
            'item-text flex-1 text-sm leading-relaxed transition-all',
            item.checked ? 'text-dim line-through' : 'text-bright'
          ]}
        >
          {item.text}
        </span>

        <span class="status-icon flex-shrink-0 text-xs text-complete-pulse transition-opacity" style={item.checked ? '' : 'opacity: 0'}>
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </span>

        {interactive && (
          <!-- Loading spinner (hidden by default) -->
          <span class="loading-spinner flex-shrink-0 hidden">
            <svg class="w-4 h-4 animate-spin text-synapse-cyan" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          </span>
        )}
      </li>
    ))}
  </ul>

  {interactive && (
    <!-- Error toast (hidden by default) -->
    <div class="error-toast fixed bottom-4 right-4 bg-alert-flare/90 text-white px-4 py-3 rounded-lg shadow-lg hidden z-50 flex items-center gap-2">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <span class="error-message">Erro ao salvar. Tente novamente.</span>
    </div>
  )}
</div>

<style>
  .checklist-item {
    animation: fade-in 0.3s ease-out;
  }

  .checklist-item.is-syncing {
    opacity: 0.7;
    pointer-events: none;
  }

  .checklist-item.is-checked .checkbox-indicator {
    animation: check-pulse 0.3s ease-out;
  }

  @keyframes fade-in {
    from {
      opacity: 0;
      transform: translateY(4px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes check-pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
  }

  .error-toast.show {
    display: flex !important;
    animation: slide-in 0.3s ease-out;
  }

  @keyframes slide-in {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>

<script>
  // Import the checklist module which auto-initializes on load
  import '../scripts/interactive-checklist';
</script>
