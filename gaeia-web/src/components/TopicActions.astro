---
import type { Topico } from '../types/trilhas';
import { NIVEL_LABELS } from '../utils/uiConstants';
import { formatResourcesForExport } from '../utils/resources';

interface Props {
  topico: Topico;
  trilhaContext?: {
    trilhaNome: string;
    moduloNome: string;
    posicao: number;
    total: number;
  };
}

const { topico, trilhaContext } = Astro.props;

const rawMarkdown = topico.content;

let enrichedContent = `# ${topico.titulo}\nNível: ${NIVEL_LABELS[topico.nivel]} | Tempo estimado: ${topico.tempoEstimado}min | Tags: ${topico.tags.join(', ')}`;

if (trilhaContext) {
  enrichedContent += `\n\n## Contexto da Trilha\nTrilha: ${trilhaContext.trilhaNome}\nMódulo: ${trilhaContext.moduloNome}\nPosição: Tópico ${trilhaContext.posicao} de ${trilhaContext.total}`;
}

enrichedContent += `\n\n---\n\n${topico.content}`;

const hasResources = topico.resources.length > 0;
if (hasResources) {
  const resourcesExport = formatResourcesForExport(topico.resources, topico.titulo);
  enrichedContent += `\n\n---\n\n${resourcesExport}`;
}
---

<div
  class="topic-actions-bar"
  data-raw-markdown={rawMarkdown}
  data-enriched-content={enrichedContent}
>
  <div class="topic-actions-inner">
    <span class="topic-actions-label">
      <svg class="ta-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
      </svg>
      AÇÕES
    </span>
    <div class="topic-actions-group">
      <button class="topic-action-btn" data-action="copy-markdown">
        <svg class="ta-icon icon-default" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
        </svg>
        <svg class="ta-icon icon-success hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
        <span class="btn-text">Copiar Markdown</span>
      </button>
      <span class="topic-actions-divider"></span>
      <button class="topic-action-btn" data-action="notebooklm">
        <svg class="ta-icon icon-default" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
        </svg>
        <svg class="ta-icon icon-success hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
        <span class="btn-text">NotebookLM</span>
      </button>
    </div>
  </div>
</div>

<style>
  .topic-actions-bar {
    margin-top: 1.5rem;
    position: relative;
  }

  /* Gradient line on top */
  .topic-actions-bar::before {
    content: '';
    display: block;
    height: 2px;
    background: linear-gradient(90deg, transparent, rgba(0, 212, 255, 0.4), rgba(139, 92, 246, 0.3), transparent);
    border-radius: 1px;
  }

  .topic-actions-inner {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.5rem 1rem;
    background: rgba(15, 23, 42, 0.5);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    border: 1px solid rgba(136, 146, 176, 0.15);
    border-top: none;
    border-radius: 0 0 10px 10px;
  }

  .topic-actions-label {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.6875rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-faint, rgba(136, 146, 176, 0.7));
    user-select: none;
  }

  .ta-icon {
    width: 14px;
    height: 14px;
    flex-shrink: 0;
  }

  .topic-actions-group {
    display: flex;
    align-items: center;
    gap: 0;
  }

  .topic-actions-divider {
    width: 1px;
    height: 1.25rem;
    background: rgba(136, 146, 176, 0.3);
    flex-shrink: 0;
  }

  .topic-action-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.25rem 0.625rem;
    background: transparent;
    border: none;
    border-radius: 4px;
    color: var(--text-faint, rgba(136, 146, 176, 0.7));
    font-family: 'IBM Plex Sans', sans-serif;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .topic-action-btn:hover {
    background: rgba(0, 212, 255, 0.08);
    color: var(--synapse-cyan, #00d4ff);
  }

  .topic-action-btn:active {
    transform: scale(0.98);
  }

  .topic-action-btn.copied {
    color: var(--complete-pulse, #00ff88);
    background: rgba(0, 255, 136, 0.08);
  }

  .topic-action-btn .hidden {
    display: none;
  }

  /* Mobile */
  @media (max-width: 640px) {
    .topic-actions-inner {
      flex-direction: column;
      padding: 0;
    }

    .topic-actions-label {
      width: 100%;
      padding: 0.5rem 1rem;
      border-bottom: 1px solid rgba(136, 146, 176, 0.15);
    }

    .topic-actions-group {
      display: flex;
      width: 100%;
    }

    .topic-actions-divider {
      display: none;
    }

    .topic-action-btn {
      flex: 1;
      justify-content: center;
      padding: 0.5rem;
      border-radius: 0;
      border-right: 1px solid rgba(136, 146, 176, 0.15);
    }

    .topic-action-btn:last-child {
      border-right: none;
    }
  }
</style>

<script>
  function initTopicActions() {
    document.querySelectorAll<HTMLDivElement>('.topic-actions-bar').forEach(container => {
      const rawMarkdown = container.dataset.rawMarkdown || '';
      const enrichedContent = container.dataset.enrichedContent || '';

      const copyBtn = container.querySelector<HTMLButtonElement>('[data-action="copy-markdown"]');
      const notebookBtn = container.querySelector<HTMLButtonElement>('[data-action="notebooklm"]');

      function showCopiedFeedback(btn: HTMLButtonElement, originalText: string) {
        const iconDefault = btn.querySelector('.icon-default') as HTMLElement;
        const iconSuccess = btn.querySelector('.icon-success') as HTMLElement;
        const btnText = btn.querySelector('.btn-text') as HTMLElement;

        btn.classList.add('copied');
        iconDefault.classList.add('hidden');
        iconSuccess.classList.remove('hidden');
        btnText.textContent = 'Copiado!';

        setTimeout(() => {
          btn.classList.remove('copied');
          iconDefault.classList.remove('hidden');
          iconSuccess.classList.add('hidden');
          btnText.textContent = originalText;
        }, 2000);
      }

      copyBtn?.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(rawMarkdown);
          showCopiedFeedback(copyBtn, 'Copiar Markdown');
        } catch {
          console.error('Failed to copy markdown');
        }
      });

      notebookBtn?.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(enrichedContent);
          showCopiedFeedback(notebookBtn, 'NotebookLM');
          setTimeout(() => {
            window.open('https://notebooklm.google.com/', '_blank');
          }, 800);
        } catch {
          console.error('Failed to copy enriched content');
        }
      });

    });
  }

  initTopicActions();
  document.addEventListener('astro:after-swap', initTopicActions);
</script>
