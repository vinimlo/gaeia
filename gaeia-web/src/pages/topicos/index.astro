---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getAllTopicos, getAllTags, getTopicoTrilhas } from '../../utils/trilhas';
import type { Topico } from '../../types/trilhas';
import { url } from '../../utils/url';

// Load all topics and tags
const topicos = await getAllTopicos();
const allTags = await getAllTags();

// Level labels
const nivelLabels: Record<string, string> = {
  iniciante: 'Iniciante',
  intermediario: 'Intermediario',
  avancado: 'Avancado',
};

const nivelColors: Record<string, string> = {
  iniciante: 'text-complete-pulse bg-complete-pulse/10',
  intermediario: 'text-axon-amber bg-axon-amber/10',
  avancado: 'text-alarm-red bg-alarm-red/10',
};

// Group topics by first tag (category)
const groupedByTag = new Map<string, Topico[]>();
for (const topico of topicos) {
  const mainTag = topico.tags[0] || 'outros';
  if (!groupedByTag.has(mainTag)) {
    groupedByTag.set(mainTag, []);
  }
  groupedByTag.get(mainTag)!.push(topico);
}
---

<BaseLayout title="Biblioteca de Topicos">
  <div class="space-y-10 animate-fade-in">
    <!-- Header -->
    <header>
      <h1 class="text-3xl md:text-4xl font-display font-bold text-bright mb-4">
        Biblioteca de Topicos
      </h1>
      <p class="text-dim text-lg max-w-3xl">
        Explore todos os topicos dispon√≠veis. Cada topico e uma unidade atomica
        de conhecimento que pode aparecer em multiplas trilhas de aprendizado.
      </p>
    </header>

    <!-- Search and Filters -->
    <section class="glass-card p-4 rounded-xl">
      <div class="flex flex-col md:flex-row gap-4">
        <!-- Search -->
        <div class="flex-1">
          <div class="relative">
            <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-dim" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            <input
              type="text"
              id="search-input"
              placeholder="Buscar topicos..."
              class="w-full pl-10 pr-4 py-2 bg-deep-space border border-star-dust/30 rounded-lg text-bright placeholder:text-dim focus:outline-none focus:border-synapse-cyan/50"
            />
          </div>
        </div>

        <!-- Tag Filter -->
        <div class="flex flex-wrap gap-2">
          <button
            class="tag-filter px-3 py-1 rounded-full text-sm border border-synapse-cyan/50 text-synapse-cyan bg-synapse-cyan/10"
            data-tag="all"
          >
            Todos
          </button>
          {allTags.slice(0, 8).map(tag => (
            <button
              class="tag-filter px-3 py-1 rounded-full text-sm border border-star-dust/30 text-dim hover:border-synapse-cyan/30 hover:text-synapse-cyan transition-colors"
              data-tag={tag}
            >
              {tag}
            </button>
          ))}
        </div>
      </div>
    </section>

    <!-- Stats -->
    <section class="grid grid-cols-2 md:grid-cols-4 gap-4">
      <div class="glass-card p-4 rounded-lg text-center">
        <span class="text-2xl font-display font-bold text-synapse-cyan">{topicos.length}</span>
        <p class="text-sm text-dim mt-1">Topicos</p>
      </div>
      <div class="glass-card p-4 rounded-lg text-center">
        <span class="text-2xl font-display font-bold text-dendrite-violet">{allTags.length}</span>
        <p class="text-sm text-dim mt-1">Tags</p>
      </div>
      <div class="glass-card p-4 rounded-lg text-center">
        <span class="text-2xl font-display font-bold text-complete-pulse">{topicos.filter(t => t.nivel === 'iniciante').length}</span>
        <p class="text-sm text-dim mt-1">Iniciante</p>
      </div>
      <div class="glass-card p-4 rounded-lg text-center">
        <span class="text-2xl font-display font-bold text-axon-amber">{topicos.filter(t => t.nivel !== 'iniciante').length}</span>
        <p class="text-sm text-dim mt-1">Avancado</p>
      </div>
    </section>

    <!-- Topics Grid -->
    <section id="topics-grid" class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
      {topicos.map((topico) => (
        <a
          href={url(`/topicos/${topico.id}`)}
          class="topic-card glass-card p-5 rounded-xl hover:border-synapse-cyan/50 transition-all group"
          data-tags={topico.tags.join(',')}
          data-titulo={topico.titulo.toLowerCase()}
        >
          <div class="flex items-start gap-3">
            <div class="w-10 h-10 rounded-lg bg-synapse-cyan/20 flex items-center justify-center flex-shrink-0 group-hover:glow-cyan transition-shadow">
              <svg class="w-5 h-5 text-synapse-cyan" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
              </svg>
            </div>

            <div class="flex-1 min-w-0">
              <h3 class="font-display font-semibold text-bright group-hover:text-synapse-cyan transition-colors mb-1">
                {topico.titulo}
              </h3>

              <div class="flex items-center gap-2 text-xs mb-2">
                <span class={`px-2 py-0.5 rounded-full ${nivelColors[topico.nivel]}`}>
                  {nivelLabels[topico.nivel]}
                </span>
                <span class="text-dim">~{topico.tempoEstimado} min</span>
              </div>

              <div class="flex flex-wrap gap-1">
                {topico.tags.slice(0, 3).map(tag => (
                  <span class="px-2 py-0.5 rounded bg-star-dust/20 text-xs text-dim">
                    {tag}
                  </span>
                ))}
              </div>
            </div>
          </div>
        </a>
      ))}
    </section>

    <!-- Empty State -->
    <div id="empty-state" class="hidden text-center py-12">
      <svg class="w-16 h-16 mx-auto text-dim mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <p class="text-dim">Nenhum topico encontrado</p>
    </div>
  </div>
</BaseLayout>

<script>
  // Search and filter functionality
  const searchInput = document.getElementById('search-input') as HTMLInputElement;
  const tagButtons = document.querySelectorAll('.tag-filter');
  const topicCards = document.querySelectorAll('.topic-card');
  const emptyState = document.getElementById('empty-state');

  let activeTag = 'all';

  function filterTopics() {
    const searchTerm = searchInput?.value.toLowerCase() || '';
    let visibleCount = 0;

    topicCards.forEach(card => {
      const tags = card.getAttribute('data-tags')?.split(',') || [];
      const titulo = card.getAttribute('data-titulo') || '';

      const matchesSearch = titulo.includes(searchTerm) || tags.some(t => t.includes(searchTerm));
      const matchesTag = activeTag === 'all' || tags.includes(activeTag);

      if (matchesSearch && matchesTag) {
        card.classList.remove('hidden');
        visibleCount++;
      } else {
        card.classList.add('hidden');
      }
    });

    // Show/hide empty state
    if (emptyState) {
      emptyState.classList.toggle('hidden', visibleCount > 0);
    }
  }

  // Search input handler
  searchInput?.addEventListener('input', filterTopics);

  // Tag filter handlers
  tagButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      // Update active state
      tagButtons.forEach(b => {
        b.classList.remove('border-synapse-cyan/50', 'text-synapse-cyan', 'bg-synapse-cyan/10');
        b.classList.add('border-star-dust/30', 'text-dim');
      });
      btn.classList.remove('border-star-dust/30', 'text-dim');
      btn.classList.add('border-synapse-cyan/50', 'text-synapse-cyan', 'bg-synapse-cyan/10');

      activeTag = btn.getAttribute('data-tag') || 'all';
      filterTopics();
    });
  });
</script>
