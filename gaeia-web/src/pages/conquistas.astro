---
import BaseLayout from '../layouts/BaseLayout.astro';
import BadgeDisplay from '../components/BadgeDisplay.astro';
import ProgressBar from '../components/ProgressBar.astro';
import { getAllTrilhas, getAllTopicos } from '../utils/trilhas';
import { calculateEarnedBadges, getBadgesByRarity } from '../utils/badges';
import { RARITY_NAMES } from '../utils/uiConstants';
import { url } from '../utils/url';

// Load trilhas and topics data
const trilhas = await getAllTrilhas();
const topicos = await getAllTopicos();
const totalTopicos = topicos.length;

// Calculate badges (will be hydrated client-side)
const allBadges = calculateEarnedBadges();

const earnedBadges = allBadges.filter(b => b.earned);
const totalBadges = allBadges.length;
const earnedCount = earnedBadges.length;
const progress = Math.round((earnedCount / totalBadges) * 100);

const badgesByRarity = getBadgesByRarity(allBadges);

// Section container colors (different opacity from badge-level RARITY_COLORS)
const sectionColors = {
  common: { text: 'text-dim', bg: 'bg-dim/20', border: 'border-dim/30' },
  rare: { text: 'text-synapse-cyan', bg: 'bg-synapse-cyan/20', border: 'border-synapse-cyan/30' },
  epic: { text: 'text-dendrite-violet', bg: 'bg-dendrite-violet/20', border: 'border-dendrite-violet/30' },
  legendary: { text: 'text-axon-amber', bg: 'bg-axon-amber/20', border: 'border-axon-amber/30' },
};
---

<BaseLayout title="Conquistas">
  <div class="space-y-10 animate-fade-in">
    <!-- Header -->
    <header>
      <h1 class="text-3xl md:text-4xl font-display font-bold text-bright mb-4">
        Conquistas
      </h1>
      <p class="text-dim text-lg max-w-3xl">
        Colecione badges ao longo de sua jornada. Cada conquista representa um
        marco importante no seu desenvolvimento como Engenheiro de IA.
      </p>
    </header>

    <!-- Progress Overview -->
    <section class="glass-card p-6 rounded-xl">
      <div class="flex flex-col md:flex-row items-center gap-6">
        <div class="text-center md:text-left">
          <div class="flex items-baseline gap-2">
            <span class="text-5xl font-display font-bold text-synapse-cyan" id="earned-count">{earnedCount}</span>
            <span class="text-2xl text-dim">/ {totalBadges}</span>
          </div>
          <p class="text-dim mt-1">conquistas desbloqueadas</p>
        </div>

        <div class="flex-1 w-full md:max-w-md">
          <div class="flex items-center justify-between text-sm mb-2">
            <span class="text-dim">Progresso de Colecao</span>
            <span class="text-synapse-cyan font-medium" id="badge-progress">{progress}%</span>
          </div>
          <ProgressBar value={progress} height={12} />
        </div>

        <div class="grid grid-cols-4 gap-4 text-center">
          {Object.entries(badgesByRarity).map(([rarity, badges]) => {
            const earned = badges.filter(b => b.earned).length;
            const colors = sectionColors[rarity as keyof typeof sectionColors];
            return (
              <div class={`px-3 py-2 rounded-lg ${colors.bg} border ${colors.border}`}>
                <span class={`text-lg font-bold ${colors.text}`}>{earned}/{badges.length}</span>
                <p class="text-xs text-faint">{RARITY_NAMES[rarity as keyof typeof RARITY_NAMES]}</p>
              </div>
            );
          })}
        </div>
      </div>
    </section>

    <!-- Stats Section -->
    <section class="glass-card p-6 rounded-xl">
      <h2 class="text-xl font-display font-semibold text-bright mb-6 flex items-center gap-2">
        <svg class="w-5 h-5 text-dendrite-violet" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
        </svg>
        Estatisticas
      </h2>
      <div class="grid md:grid-cols-3 gap-6">
        <div class="text-center">
          <span class="text-3xl font-display font-bold text-synapse-cyan">{trilhas.length}</span>
          <p class="text-sm text-dim mt-1">Trilhas Disponiveis</p>
        </div>
        <div class="text-center">
          <span class="text-3xl font-display font-bold text-dendrite-violet">{totalTopicos}</span>
          <p class="text-sm text-dim mt-1">Topicos Totais</p>
        </div>
        <div class="text-center">
          <span class="text-3xl font-display font-bold text-axon-amber" id="completed-topics">0</span>
          <p class="text-sm text-dim mt-1">Topicos Completos</p>
        </div>
      </div>
    </section>

    <!-- All Badges by Rarity -->
    {Object.entries(badgesByRarity).reverse().map(([rarity, badges]) => {
      const colors = sectionColors[rarity as keyof typeof sectionColors];
      const earned = badges.filter(b => b.earned).length;

      return (
        <section>
          <h2 class={`text-xl font-display font-semibold mb-4 flex items-center gap-2 ${colors.text}`}>
            <span class={`w-3 h-3 rounded-full ${colors.bg.replace('/20', '')}`} />
            {RARITY_NAMES[rarity as keyof typeof RARITY_NAMES]}
            <span class="text-sm font-normal text-dim">({earned}/{badges.length})</span>
          </h2>

          <div class="glass-card p-6 rounded-xl">
            <div class="flex flex-wrap gap-6">
              {badges.map(badge => (
                <div class="flex flex-col items-center gap-2">
                  <BadgeDisplay
                    id={badge.id}
                    name={badge.name}
                    description={badge.description}
                    icon={badge.icon}
                    earned={badge.earned}
                    earnedDate={badge.earnedDate}
                    rarity={badge.rarity}
                    size="lg"
                  />
                  <span class={`text-xs text-center max-w-[80px] ${badge.earned ? 'text-bright' : 'text-faint'}`}>
                    {badge.name}
                  </span>
                </div>
              ))}
            </div>
          </div>
        </section>
      );
    })}

    <!-- Motivational Section -->
    <section class="glass-card p-6 rounded-xl text-center">
      <h3 class="font-display font-semibold text-bright mb-3">
        Continue sua jornada!
      </h3>
      <p class="text-dim text-sm mb-4 max-w-lg mx-auto">
        Cada badge representa um passo importante. Continue estudando,
        praticando e conquistando novos marcos em sua carreira de IA.
      </p>
      <a
        href={url('/trilhas')}
        class="inline-flex items-center gap-2 px-6 py-3 bg-synapse-cyan/20 hover:bg-synapse-cyan/30 border border-synapse-cyan/50 rounded-lg text-synapse-cyan font-medium transition-all hover:glow-cyan"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
        </svg>
        Explorar Trilhas
      </a>
    </section>
  </div>
</BaseLayout>

<script>
  // Hydrate completed topics count from localStorage
  import { getCompletedTopicosCount } from '../utils/progressStore';

  function updateStats() {
    const count = getCompletedTopicosCount();
    const completedEl = document.getElementById('completed-topics');
    if (completedEl) {
      completedEl.textContent = String(count);
    }
  }

  // Run on page load
  updateStats();
</script>
