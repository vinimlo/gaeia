---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import ProgressBar from '../../../components/ProgressBar.astro';
import { getAllTrilhas, getTrilha, getTopico, getTopicoNavigation, getTrilhaTopicoIds } from '../../../utils/trilhas';
import { renderMarkdownAsync } from '../../../utils/markdown';
import type { Trilha, Topico, TopicoNavigation } from '../../../types/trilhas';
import { url } from '../../../utils/url';

export async function getStaticPaths() {
  const trilhas = await getAllTrilhas();
  const paths = [];

  for (const trilha of trilhas) {
    const topicoIds = getTrilhaTopicoIds(trilha);
    for (const topicoId of topicoIds) {
      paths.push({
        params: { trilha: trilha.id, topico: topicoId },
      });
    }
  }

  return paths;
}

const { trilha: trilhaId, topico: topicoId } = Astro.params;

const trilha = await getTrilha(trilhaId);
const topico = await getTopico(topicoId);
const navigation = await getTopicoNavigation(trilhaId, topicoId);

if (!trilha || !topico || !navigation) {
  return Astro.redirect(url('/trilhas'));
}

// Render markdown content
const renderedContent = await renderMarkdownAsync(topico.content);

// Level labels
const nivelLabels: Record<string, string> = {
  iniciante: 'Iniciante',
  intermediario: 'Intermediario',
  avancado: 'Avancado',
};

const nivelColors: Record<string, string> = {
  iniciante: 'text-complete-pulse bg-complete-pulse/15 border border-complete-pulse/30',
  intermediario: 'text-axon-amber bg-axon-amber/15 border border-axon-amber/30',
  avancado: 'text-alarm-red bg-alarm-red/15 border border-alarm-red/30',
};
---

<BaseLayout title={`${topico.titulo} | ${trilha.nome}`}>
  <article class="animate-fade-in">
    <!-- Breadcrumb -->
    <nav class="flex items-center gap-2 mb-6 text-sm">
      <a href={url('/trilhas')} class="text-dim hover:text-synapse-cyan transition-colors">
        Trilhas
      </a>
      <span class="text-dim">/</span>
      <a href={url(`/trilhas/${trilha.id}`)} class="text-dim hover:text-synapse-cyan transition-colors">
        {trilha.nome}
      </a>
      <span class="text-dim">/</span>
      <span class="text-synapse-cyan">{topico.titulo}</span>
    </nav>

    <!-- Header -->
    <header class="mb-8">
      <div class="flex items-center gap-3 mb-4">
        <span class="px-3 py-1 rounded-full bg-dendrite-violet/20 text-dendrite-violet text-sm font-medium">
          {navigation.modulo.nome}
        </span>
        <span class={`px-3 py-1 rounded-full text-sm font-medium ${nivelColors[topico.nivel]}`}>
          {nivelLabels[topico.nivel]}
        </span>
        <span class="text-dim text-sm">
          ~{topico.tempoEstimado} min
        </span>
      </div>

      <h1 class="text-3xl md:text-4xl font-display font-bold text-bright mb-4">
        {topico.titulo}
      </h1>

      <!-- Position indicator -->
      <div class="flex items-center gap-4 text-sm text-dim">
        <span>
          Topico {navigation.posicaoNaTrilha + 1} de {navigation.totalNaTrilha}
        </span>
        {topico.tags.length > 0 && (
          <div class="flex items-center gap-2">
            {topico.tags.slice(0, 3).map(tag => (
              <span class="px-2 py-0.5 rounded bg-star-dust/30 text-xs">
                {tag}
              </span>
            ))}
          </div>
        )}
      </div>

      <!-- Progress (will be hydrated client-side) -->
      <div class="mt-6" data-topico-progress={topico.id}>
        <div class="flex items-center justify-between mb-2">
          <span class="text-sm text-dim">Progresso do Topico</span>
          <span class="text-sm font-medium text-synapse-cyan">0%</span>
        </div>
        <ProgressBar value={0} />
      </div>
    </header>

    <!-- Content -->
    <div class="markdown-content mb-8" set:html={renderedContent} />

    <!-- This topic appears in other trails -->
    <section class="mt-8 glass-card p-4 rounded-lg bg-deep-space/50">
      <p class="text-sm text-dim flex items-center gap-2">
        <svg class="w-4 h-4 text-dendrite-violet" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        Este topico tambem pode ser acessado em
        <a href={url(`/topicos/${topico.id}`)} class="text-synapse-cyan hover:underline">
          /topicos/{topico.id}
        </a>
      </p>
    </section>

    <!-- Navigation -->
    <nav class="mt-12 flex justify-between items-center pt-8 border-t border-star-dust/50">
      {navigation.anterior ? (
        <a
          href={url(`/trilhas/${trilha.id}/${navigation.anterior}`)}
          class="flex items-center gap-2 text-dim hover:text-synapse-cyan transition-colors"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
          Anterior
        </a>
      ) : (
        <a
          href={url(`/trilhas/${trilha.id}`)}
          class="flex items-center gap-2 text-dim hover:text-synapse-cyan transition-colors"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
          Voltar para Trilha
        </a>
      )}

      <div class="text-center text-sm text-dim">
        {navigation.posicaoNaTrilha + 1} / {navigation.totalNaTrilha}
      </div>

      {navigation.proximo ? (
        <a
          href={url(`/trilhas/${trilha.id}/${navigation.proximo}`)}
          class="flex items-center gap-2 text-dim hover:text-synapse-cyan transition-colors"
        >
          Proximo
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
        </a>
      ) : (
        <a
          href={url(`/trilhas/${trilha.id}`)}
          class="flex items-center gap-2 text-complete-pulse hover:text-complete-pulse/80 transition-colors"
        >
          Concluir Trilha
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
          </svg>
        </a>
      )}
    </nav>
  </article>
</BaseLayout>

<script>
  // Import progress tracking
  import { recordActivity } from '../../../utils/progressStore';
  // Import interactive checklist for inline hydration
  import '../../../scripts/interactive-checklist';

  // Record activity when visiting a topic
  recordActivity();
</script>
